Middleware for checking user authentication and permissions.